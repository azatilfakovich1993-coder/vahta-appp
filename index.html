<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>–í–∞—Ö—Ç–∞–ü–æ–∏—Å–∫</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Unbounded:wght@400;700;900&family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{--c1:#0f172a;--c2:#1e293b;--accent:#f97316;--accent2:#fb923c;--green:#22c55e;--red:#ef4444;--blue:#3b82f6;--gold:#f59e0b;--bg:#f1f5f9;--card:#fff;--text:#0f172a;--text2:#475569;--text3:#94a3b8;--border:#e2e8f0;}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{font-family:'Manrope',sans-serif;background:var(--bg);color:var(--text);line-height:1.6;overflow-x:hidden;}
.hidden{display:none!important;}
.topbar{background:linear-gradient(135deg,var(--c1),var(--c2));padding:16px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:200;}
.topbar-left{display:flex;align-items:center;gap:10px;}
.topbar-back{background:rgba(255,255,255,0.1);border:none;color:white;width:36px;height:36px;border-radius:50%;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;}
.topbar-title{font-family:'Unbounded',sans-serif;font-size:16px;font-weight:700;color:white;}
.topbar-subtitle{font-size:11px;color:rgba(255,255,255,0.6);margin-top:1px;}
.topbar-btn{background:rgba(255,255,255,0.12);border:1px solid rgba(255,255,255,0.15);color:white;padding:8px 12px;border-radius:20px;font-size:13px;font-weight:600;cursor:pointer;position:relative;display:flex;align-items:center;gap:5px;}
.topbar-btn .cnt{background:var(--red);color:white;font-size:10px;padding:2px 5px;border-radius:8px;font-weight:700;}
.hero{background:linear-gradient(135deg,var(--c1) 0%,#1a2744 100%);padding:40px 20px 50px;text-align:center;position:relative;overflow:hidden;}
.hero::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:radial-gradient(circle at 60% 40%,rgba(249,115,22,0.12),transparent 60%);pointer-events:none;}
.hero-logo{font-family:'Unbounded',sans-serif;font-size:28px;font-weight:900;color:white;margin-bottom:8px;}
.hero-logo span{color:var(--accent);}
.hero-sub{color:rgba(255,255,255,0.65);font-size:14px;margin-bottom:36px;}
.role-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;padding:0 20px 30px;}
.role-card{background:white;border-radius:16px;padding:24px 16px;text-align:center;cursor:pointer;transition:transform 0.2s;box-shadow:0 4px 12px rgba(0,0,0,0.08);}
.role-card:active{transform:scale(0.97);}
.role-card-ico{font-size:44px;margin-bottom:12px;}
.role-card-title{font-family:'Unbounded',sans-serif;font-size:13px;font-weight:700;margin-bottom:6px;}
.role-card-desc{font-size:12px;color:var(--text2);line-height:1.4;}
.tabs-wrap{background:white;border-bottom:1px solid var(--border);display:flex;overflow-x:auto;position:sticky;top:58px;z-index:100;}
.tabs-wrap::-webkit-scrollbar{display:none;}
.tab-btn{flex:1;min-width:80px;padding:14px 8px;background:none;border:none;color:var(--text3);font-size:13px;font-weight:600;cursor:pointer;border-bottom:3px solid transparent;white-space:nowrap;font-family:'Manrope',sans-serif;}
.tab-btn.active{color:var(--accent);border-bottom-color:var(--accent);}
.search-bar{padding:14px 16px;background:white;border-bottom:1px solid var(--border);}
.search-input-wrap{position:relative;margin-bottom:12px;}
.search-input-wrap input{width:100%;padding:11px 16px 11px 42px;border:2px solid var(--border);border-radius:12px;font-size:14px;font-family:'Manrope',sans-serif;transition:border-color 0.2s;}
.search-input-wrap input:focus{outline:none;border-color:var(--accent);}
.s-ico{position:absolute;left:14px;top:50%;transform:translateY(-50%);font-size:18px;color:var(--text3);}
.filters-row{display:flex;gap:8px;overflow-x:auto;padding-bottom:4px;}
.filters-row::-webkit-scrollbar{display:none;}
.fchip{padding:7px 14px;border-radius:20px;background:var(--bg);border:2px solid transparent;font-size:12px;font-weight:600;white-space:nowrap;cursor:pointer;color:var(--text2);}
.fchip.on{background:var(--accent);color:white;}
.list-wrap{padding:12px 16px 90px;}
.vcard{background:white;border-radius:16px;margin-bottom:12px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,0.08);cursor:pointer;transition:transform 0.15s;}
.vcard:active{transform:scale(0.99);}
.vcard-top{padding:16px 16px 12px;}
.vcard-head{display:flex;justify-content:space-between;align-items:start;margin-bottom:8px;}
.vcard-title{font-family:'Unbounded',sans-serif;font-size:14px;font-weight:700;color:var(--text);line-height:1.3;}
.vcard-fav{background:none;border:none;font-size:22px;cursor:pointer;padding:2px;transition:transform 0.2s;flex-shrink:0;}
.vcard-fav:active{transform:scale(1.3);}
.vcard-company{font-size:13px;color:var(--text2);margin-bottom:6px;display:flex;align-items:center;gap:4px;}
.vcard-rating{font-size:12px;color:var(--gold);font-weight:700;}
.vcard-salary{font-size:20px;font-weight:700;color:var(--green);margin-bottom:10px;}
.vcard-tags{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px;}
.vtag{background:var(--bg);padding:5px 10px;border-radius:8px;font-size:12px;color:var(--text2);font-weight:500;}
.vtag-blue{background:#dbeafe;color:#1d4ed8;}
.vtag-green{background:#dcfce7;color:#15803d;}
.vtag-orange{background:#fff7ed;color:#c2410c;}
.vcard-desc{font-size:13px;color:var(--text2);padding:10px 16px;border-top:1px solid var(--bg);display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;}
.vcard-footer{padding:10px 16px;background:var(--bg);display:flex;justify-content:space-between;align-items:center;}
.vcard-date{font-size:11px;color:var(--text3);}
.vcard-responses{font-size:11px;color:var(--text2);font-weight:600;}
.status-active{background:#dcfce7;color:#15803d;padding:3px 8px;border-radius:10px;font-size:11px;font-weight:600;}
.status-paused{background:#fef3c7;color:#92400e;padding:3px 8px;border-radius:10px;font-size:11px;font-weight:600;}
.status-closed{background:#fee2e2;color:#991b1b;padding:3px 8px;border-radius:10px;font-size:11px;font-weight:600;}
.avatar-circle{width:72px;height:72px;border-radius:50%;object-fit:cover;border:3px solid var(--accent);}
.avatar-placeholder{width:72px;height:72px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-size:30px;margin:0 auto;}
.btn{display:flex;align-items:center;justify-content:center;gap:8px;padding:14px 20px;border-radius:12px;font-size:15px;font-weight:700;cursor:pointer;border:none;font-family:'Manrope',sans-serif;width:100%;transition:all 0.2s;}
.btn:active{transform:scale(0.98);}
.btn-primary{background:linear-gradient(135deg,var(--accent),var(--accent2));color:white;}
.btn-green{background:linear-gradient(135deg,#22c55e,#16a34a);color:white;}
.btn-blue{background:linear-gradient(135deg,#3b82f6,#2563eb);color:white;}
.btn-outline{background:transparent;border:2px solid var(--border);color:var(--text);}
.btn-danger{background:linear-gradient(135deg,#ef4444,#dc2626);color:white;}
.btn-warn{background:linear-gradient(135deg,#f59e0b,#d97706);color:white;}
.btn-sm{padding:10px 16px;font-size:13px;}
.btn-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;}
.btn-row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-top:10px;}
.fab{position:fixed;bottom:80px;right:16px;width:56px;height:56px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));color:white;border:none;font-size:28px;box-shadow:0 4px 16px rgba(249,115,22,0.4);cursor:pointer;z-index:50;display:flex;align-items:center;justify-content:center;}
.bottom-nav{position:fixed;bottom:0;left:0;right:0;background:white;border-top:1px solid var(--border);display:flex;z-index:150;}
.bnav-item{flex:1;display:flex;flex-direction:column;align-items:center;gap:3px;padding:10px 8px;background:none;border:none;color:var(--text3);font-size:10px;font-weight:600;cursor:pointer;font-family:'Manrope',sans-serif;position:relative;}
.bnav-item.active{color:var(--accent);}
.bnav-ico{font-size:22px;}
.bnav-cnt{position:absolute;top:6px;right:calc(50% - 18px);background:var(--red);color:white;font-size:9px;padding:1px 5px;border-radius:8px;font-weight:700;}
.form-wrap{padding:16px;}
.fg{margin-bottom:18px;}
.fg label{display:block;font-size:13px;font-weight:700;margin-bottom:7px;color:var(--text);}
.req{color:var(--red);margin-left:3px;}
.fg input,.fg select,.fg textarea{width:100%;padding:12px 14px;border:2px solid var(--border);border-radius:10px;font-size:14px;font-family:'Manrope',sans-serif;color:var(--text);transition:border-color 0.2s;background:white;}
.fg input:focus,.fg select:focus,.fg textarea:focus{outline:none;border-color:var(--accent);}
.fg textarea{min-height:90px;resize:vertical;}
.fg-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.toggle-row{display:flex;align-items:center;justify-content:space-between;padding:14px;background:var(--bg);border-radius:10px;margin-bottom:18px;}
.toggle-label{font-size:14px;font-weight:600;}
.toggle{width:48px;height:26px;background:var(--border);border-radius:13px;border:none;cursor:pointer;position:relative;transition:background 0.2s;flex-shrink:0;}
.toggle::after{content:'';position:absolute;width:20px;height:20px;background:white;border-radius:50%;top:3px;left:3px;transition:transform 0.2s;box-shadow:0 1px 4px rgba(0,0,0,0.2);}
.toggle.on{background:var(--green);}
.toggle.on::after{transform:translateX(22px);}
.modal{position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:500;display:flex;align-items:flex-end;}
.modal-box{background:white;border-radius:24px 24px 0 0;width:100%;max-height:92vh;overflow-y:auto;padding:20px;padding-bottom:40px;}
.modal-handle{width:40px;height:4px;background:var(--border);border-radius:2px;margin:0 auto 20px;}
.modal-title{font-family:'Unbounded',sans-serif;font-size:18px;font-weight:700;margin-bottom:4px;}
.modal-sub{font-size:13px;color:var(--text2);margin-bottom:20px;}
.detail-section{margin-bottom:20px;}
.detail-section-title{font-size:11px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:10px;}
.detail-row{display:flex;align-items:flex-start;gap:12px;padding:12px;background:var(--bg);border-radius:10px;margin-bottom:8px;}
.detail-ico{font-size:22px;width:32px;text-align:center;flex-shrink:0;}
.detail-info{flex:1;min-width:0;}
.detail-label{font-size:11px;color:var(--text3);margin-bottom:2px;}
.detail-value{font-size:14px;font-weight:600;color:var(--text);word-break:break-word;}
.empty{text-align:center;padding:50px 20px;}
.empty-ico{font-size:56px;margin-bottom:14px;opacity:0.4;}
.empty-title{font-family:'Unbounded',sans-serif;font-size:16px;font-weight:700;margin-bottom:8px;}
.empty-text{font-size:13px;color:var(--text2);margin-bottom:24px;line-height:1.5;}
.star{font-size:24px;cursor:pointer;}
.stars-row{display:flex;gap:4px;margin-bottom:12px;}
.toast{position:fixed;top:20px;left:50%;transform:translateX(-50%);background:var(--c1);color:white;padding:12px 20px;border-radius:12px;font-size:13px;font-weight:600;z-index:9999;box-shadow:0 4px 12px rgba(0,0,0,0.2);white-space:nowrap;animation:toastIn 0.3s ease;}
@keyframes toastIn{from{transform:translate(-50%,-20px);opacity:0;}to{transform:translate(-50%,0);opacity:1;}}
.notif-banner{position:fixed;top:0;left:0;right:0;background:linear-gradient(135deg,var(--c1),#1a2744);color:white;padding:16px;z-index:8000;transform:translateY(-100%);transition:transform 0.3s;border-bottom:2px solid var(--accent);}
.notif-banner.show{transform:translateY(0);}
.profile-hero{background:linear-gradient(135deg,var(--c1),var(--c2));padding:28px 20px;text-align:center;color:white;}
.profile-name{font-family:'Unbounded',sans-serif;font-size:16px;font-weight:700;margin-bottom:4px;margin-top:10px;}
.profile-role{font-size:13px;opacity:0.7;}
.loading{text-align:center;padding:40px;color:var(--text3);}
.spin{width:32px;height:32px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 0.8s linear infinite;margin:0 auto 10px;}
@keyframes spin{to{transform:rotate(360deg);}}
.photo-upload-area{border:2px dashed var(--border);border-radius:12px;padding:24px;text-align:center;cursor:pointer;margin-bottom:18px;}
.photo-upload-area:hover{border-color:var(--accent);}
.photo-preview{width:80px;height:80px;border-radius:50%;object-fit:cover;margin:0 auto 8px;display:block;}
</style>
</head>
<body>
<div id="app">

<div id="welcomeScreen">
  <div class="hero">
    <div class="hero-logo">–í–∞—Ö—Ç–∞<span>–ü–æ–∏—Å–∫</span></div>
    <div class="hero-sub">–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –≤–∞—Ö—Ç–æ–≤–æ–π –∑–∞–Ω—è—Ç–æ—Å—Ç–∏</div>
  </div>
  <div class="role-grid">
    <div class="role-card" onclick="goRole('employer')">
      <div class="role-card-ico">üëî</div>
      <div class="role-card-title">–†–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª—å</div>
      <div class="role-card-desc">–ù–∞–π—Ç–∏ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤ –¥–ª—è –≤–∞—Ö—Ç–æ–≤–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞</div>
    </div>
    <div class="role-card" onclick="goRole('worker')">
      <div class="role-card-ico">üë∑</div>
      <div class="role-card-title">–°–æ–∏—Å–∫–∞—Ç–µ–ª—å</div>
      <div class="role-card-desc">–ù–∞–π—Ç–∏ –≤—ã—Å–æ–∫–æ–æ–ø–ª–∞—á–∏–≤–∞–µ–º—É—é –≤–∞—Ö—Ç–æ–≤—É—é —Ä–∞–±–æ—Ç—É</div>
    </div>
  </div>
</div>

<div id="employerScreen" class="hidden">
  <div class="topbar">
    <div class="topbar-left">
      <button class="topbar-back" onclick="goWelcome()">‚Üê</button>
      <div><div class="topbar-title">–í–∞—Ö—Ç–∞–ü–æ–∏—Å–∫</div><div class="topbar-subtitle" id="empTabLabel">–ú–æ–∏ –≤–∞–∫–∞–Ω—Å–∏–∏</div></div>
    </div>
    <button class="topbar-btn" onclick="openFavs()">‚ù§Ô∏è <span class="cnt" id="empFavCnt" style="display:none">0</span></button>
  </div>
  <div class="tabs-wrap">
    <button class="tab-btn active" onclick="empTab('vacancies',this)">–í–∞–∫–∞–Ω—Å–∏–∏</button>
    <button class="tab-btn" onclick="empTab('candidates',this)">–ö–∞–Ω–¥–∏–¥–∞—Ç—ã</button>
    <button class="tab-btn" onclick="empTab('incoming',this)">–í—Ö–æ–¥—è—â–∏–µ</button>
    <button class="tab-btn" onclick="empTab('profile',this)">–ü—Ä–æ—Ñ–∏–ª—å</button>
  </div>
  <div id="empVacanciesTab"><div class="list-wrap" id="empVacList"></div></div>
  <div id="empCandidatesTab" class="hidden">
    <div class="search-bar">
      <div class="search-input-wrap"><span class="s-ico">üîç</span><input type="text" placeholder="–ü–æ–∏—Å–∫ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤..." id="candSearch" oninput="filterCandidates()"></div>
      <div class="filters-row" id="candFilters"></div>
    </div>
    <div class="list-wrap" id="empCandList"></div>
  </div>
  <div id="empIncomingTab" class="hidden"><div class="list-wrap" id="empIncomingList"></div></div>
  <div id="empProfileTab" class="hidden"><div id="empProfileView"></div></div>
  <button class="fab" onclick="showCreateVacancy()">+</button>
  <div class="bottom-nav">
    <button class="bnav-item active" id="empBnav0" onclick="empTab('vacancies',this);setActiveBnav('empBnav0','emp')"><span class="bnav-ico">üíº</span><span>–í–∞–∫–∞–Ω—Å–∏–∏</span></button>
    <button class="bnav-item" id="empBnav1" onclick="openFavs()"><span class="bnav-ico">‚ù§Ô∏è</span><span>–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</span><span class="bnav-cnt" id="empFavBadge" style="display:none">0</span></button>
    <button class="bnav-item" id="empBnav2" onclick="empTab('profile',this);setActiveBnav('empBnav2','emp')"><span class="bnav-ico">üë§</span><span>–ü—Ä–æ—Ñ–∏–ª—å</span></button>
  </div>
</div>

<div id="workerScreen" class="hidden">
  <div class="topbar">
    <div class="topbar-left">
      <button class="topbar-back" onclick="goWelcome()">‚Üê</button>
      <div><div class="topbar-title">–í–∞—Ö—Ç–∞–ü–æ–∏—Å–∫</div><div class="topbar-subtitle" id="wrkTabLabel">–í–∞–∫–∞–Ω—Å–∏–∏</div></div>
    </div>
    <button class="topbar-btn" onclick="openFavs()">‚ù§Ô∏è <span class="cnt" id="wrkFavCnt" style="display:none">0</span></button>
  </div>
  <div class="tabs-wrap">
    <button class="tab-btn active" onclick="wrkTab('vacancies',this)">–í–∞–∫–∞–Ω—Å–∏–∏</button>
    <button class="tab-btn" onclick="wrkTab('profile',this)">–ü—Ä–æ—Ñ–∏–ª—å</button>
  </div>
  <div id="wrkVacanciesTab">
    <div class="search-bar">
      <div class="search-input-wrap"><span class="s-ico">üîç</span><input type="text" placeholder="–ü–æ–∏—Å–∫ –≤–∞–∫–∞–Ω—Å–∏–π..." id="vacSearch" oninput="filterVacancies()"></div>
      <div class="filters-row" id="vacFilters"></div>
    </div>
    <div class="list-wrap" id="wrkVacList"></div>
  </div>
  <div id="wrkProfileTab" class="hidden"><div id="wrkProfileView"></div></div>
  <div class="bottom-nav">
    <button class="bnav-item active" id="wrkBnav0" onclick="wrkTab('vacancies',this);setActiveBnav('wrkBnav0','wrk')"><span class="bnav-ico">üíº</span><span>–í–∞–∫–∞–Ω—Å–∏–∏</span></button>
    <button class="bnav-item" id="wrkBnav1" onclick="openFavs()"><span class="bnav-ico">‚ù§Ô∏è</span><span>–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</span><span class="bnav-cnt" id="wrkFavBadge" style="display:none">0</span></button>
    <button class="bnav-item" id="wrkBnav2" onclick="wrkTab('profile',this);setActiveBnav('wrkBnav2','wrk')"><span class="bnav-ico">üë§</span><span>–ü—Ä–æ—Ñ–∏–ª—å</span></button>
  </div>
</div>

<div class="notif-banner" id="notifBanner">
  <div style="font-weight:700;font-size:14px;margin-bottom:4px" id="notifTitle"></div>
  <div style="font-size:12px;opacity:0.8" id="notifText"></div>
</div>

</div>
<script>
const tg = window.Telegram.WebApp;
tg.ready(); tg.expand();

const BOT_TOKEN = '8406340321:AAE6pjKfFflkF4V2peKKWZ6-vPljslWZjlA';
const SB_URL = 'https://zutiselchauekvvoirgw.supabase.co';
const SB_KEY = 'sb_publishable__IqzaQ_ICdfryInqnfmRZg_KK_aFton';

const UID = String(tg.initDataUnsafe?.user?.id || 'demo_' + Math.random().toString(36).slice(2,8));
const UNAME = tg.initDataUnsafe?.user?.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
const TG_USERNAME = tg.initDataUnsafe?.user?.username || null;

let ROLE = null;
let favs = { vacancies: [], candidates: [] };
let allVacsCache = [];
let allCandsCache = [];

const SPECS = ['–°–≤–∞—Ä—â–∏–∫','–ú–æ–Ω—Ç–∞–∂–Ω–∏–∫','–≠–ª–µ–∫—Ç—Ä–∏–∫','–°–ª–µ—Å–∞—Ä—å','–¢–æ–∫–∞—Ä—å','–§—Ä–µ–∑–µ—Ä–æ–≤—â–∏–∫','–ú–∞–ª—è—Ä','–®—Ç—É–∫–∞—Ç—É—Ä','–ö–∞–º–µ–Ω—â–∏–∫','–ë–µ—Ç–æ–Ω—â–∏–∫','–ê—Ä–º–∞—Ç—É—Ä—â–∏–∫','–ö—Ä–∞–Ω–æ–≤—â–∏–∫','–°—Ç—Ä–æ–ø–∞–ª—å—â–∏–∫','–û–ø–µ—Ä–∞—Ç–æ—Ä —Å—Ç–∞–Ω–∫–æ–≤'];
const SCHEDS = ['15/15','30/30','45/15','45/45','60/30','2/2','3/3','–î—Ä—É–≥–æ–π –≥—Ä–∞—Ñ–∏–∫'];
const EXP_RANGES = ['–ë–µ–∑ –æ–ø—ã—Ç–∞','–î–æ 1 –≥–æ–¥–∞','1‚Äì3 –≥–æ–¥–∞','3‚Äì5 –ª–µ—Ç','5+ –ª–µ—Ç'];

// ‚îÄ‚îÄ SUPABASE API ‚îÄ‚îÄ
async function sbGet(table, id) {
  try {
    const r = await fetch(`${SB_URL}/rest/v1/${table}?id=eq.${encodeURIComponent(id)}&select=data`, {
      headers: { 'apikey': SB_KEY, 'Authorization': 'Bearer ' + SB_KEY }
    });
    const d = await r.json();
    return d && d[0] ? d[0].data : null;
  } catch(e) { return null; }
}
async function sbSet(table, id, data) {
  try {
    await fetch(`${SB_URL}/rest/v1/${table}`, {
      method: 'POST',
      headers: { 'apikey': SB_KEY, 'Authorization': 'Bearer ' + SB_KEY, 'Content-Type': 'application/json', 'Prefer': 'resolution=merge-duplicates' },
      body: JSON.stringify({ id, data })
    });
  } catch(e) {}
}
async function sbDelete(table, id) {
  try {
    await fetch(`${SB_URL}/rest/v1/${table}?id=eq.${encodeURIComponent(id)}`, {
      method: 'DELETE',
      headers: { 'apikey': SB_KEY, 'Authorization': 'Bearer ' + SB_KEY }
    });
  } catch(e) {}
}
async function sbList(table, prefix) {
  try {
    const r = await fetch(`${SB_URL}/rest/v1/${table}?id=like.${encodeURIComponent(prefix + '%')}&select=data&order=id.desc`, {
      headers: { 'apikey': SB_KEY, 'Authorization': 'Bearer ' + SB_KEY }
    });
    const d = await r.json();
    return Array.isArray(d) ? d.map(x => x.data).filter(Boolean) : [];
  } catch(e) { return []; }
}

// ‚îÄ‚îÄ LOCAL FAVS (per user) ‚îÄ‚îÄ
function loadFavsLocal() {
  try { const f = localStorage.getItem('favs_' + UID); if(f) favs = JSON.parse(f); } catch(e) {}
  updateFavUI();
}
function saveFavsLocal() {
  try { localStorage.setItem('favs_' + UID, JSON.stringify(favs)); } catch(e) {}
  updateFavUI();
}
function updateFavUI() {
  const cnt = favs.vacancies.length + favs.candidates.length;
  ['empFavCnt','wrkFavCnt'].forEach(id => { const el = document.getElementById(id); if(el) { el.textContent = cnt; el.style.display = cnt > 0 ? 'inline' : 'none'; }});
  ['empFavBadge','wrkFavBadge'].forEach(id => { const el = document.getElementById(id); if(el) { el.textContent = cnt; el.style.display = cnt > 0 ? 'inline' : 'none'; }});
}
function isFav(type, id) { return (type==='v' ? favs.vacancies : favs.candidates).includes(id); }
async function toggleFav(type, id, e) {
  if(e) e.stopPropagation();
  const list = type==='v' ? favs.vacancies : favs.candidates;
  const idx = list.indexOf(id);
  if(idx > -1) { list.splice(idx, 1); toast('–£–¥–∞–ª–µ–Ω–æ –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ'); }
  else { list.push(id); toast('–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ ‚ù§Ô∏è'); }
  saveFavsLocal();
  if(ROLE === 'employer') loadEmpVacancies();
  else loadWrkVacancies();
}

// ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ
function toast(msg) {
  document.querySelectorAll('.toast').forEach(t => t.remove());
  const t = document.createElement('div'); t.className = 'toast'; t.textContent = msg;
  document.body.appendChild(t); setTimeout(() => t.remove(), 2800);
}
function showNotif(title, text) {
  document.getElementById('notifTitle').textContent = title;
  document.getElementById('notifText').textContent = text;
  const b = document.getElementById('notifBanner');
  b.classList.add('show'); setTimeout(() => b.classList.remove('show'), 4000);
}
function timeAgo(iso) {
  const diff = Math.floor((new Date() - new Date(iso)) / 60000);
  if(diff < 1) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ'; if(diff < 60) return diff + '–º –Ω–∞–∑–∞–¥';
  if(diff < 1440) return Math.floor(diff/60) + '—á –Ω–∞–∑–∞–¥'; return Math.floor(diff/1440) + '–¥ –Ω–∞–∑–∞–¥';
}
function yrs(n) { n = parseInt(n); if(n===1) return '–≥–æ–¥'; if(n>=2&&n<=4) return '–≥–æ–¥–∞'; return '–ª–µ—Ç'; }
function salStr(a, b) {
  if(a && b) return `${parseInt(a).toLocaleString()} ‚Äî ${parseInt(b).toLocaleString()} ‚ÇΩ`;
  if(a) return `–æ—Ç ${parseInt(a).toLocaleString()} ‚ÇΩ`; return '‚Äî';
}
function starsSmall(r, c) {
  if(!r || !c) return '';
  return `<span class="vcard-rating">‚òÖ ${parseFloat(r).toFixed(1)}</span><span style="font-size:11px;color:var(--text3)"> (${c})</span>`;
}
function starsHtml(r, c) {
  if(!r) return '';
  const full = Math.round(r); let s = '';
  for(let i=1;i<=5;i++) s += i<=full?'‚≠ê':'‚òÜ';
  return `<div style="display:flex;align-items:center;gap:6px;margin-bottom:8px">${s} <b style="color:var(--gold)">${parseFloat(r).toFixed(1)}</b><span style="font-size:12px;color:var(--text3)">(${c||0})</span></div>`;
}
function isVerified(p) { return p && p.companyName && p.inn && p.address && p.about; }
function setActiveBnav(id, prefix) {
  document.querySelectorAll(`#${prefix==='emp'?'employerScreen':'workerScreen'} .bnav-item`).forEach(b => b.classList.remove('active'));
  const el = document.getElementById(id); if(el) el.classList.add('active');
}
function expRange(yrs) {
  const n = parseInt(yrs)||0;
  if(n===0) return '–ë–µ–∑ –æ–ø—ã—Ç–∞'; if(n<1) return '–î–æ 1 –≥–æ–¥–∞';
  if(n<=3) return '1‚Äì3 –≥–æ–¥–∞'; if(n<=5) return '3‚Äì5 –ª–µ—Ç'; return '5+ –ª–µ—Ç';
}

// ‚îÄ‚îÄ NAV ‚îÄ‚îÄ
function hideAll() { ['welcomeScreen','employerScreen','workerScreen'].forEach(id => document.getElementById(id).classList.add('hidden')); }
function goWelcome() { hideAll(); document.getElementById('welcomeScreen').classList.remove('hidden'); ROLE = null; }
async function goRole(role) {
  ROLE = role; hideAll(); loadFavsLocal();
  if(role === 'employer') { document.getElementById('employerScreen').classList.remove('hidden'); loadEmpVacancies(); }
  else { document.getElementById('workerScreen').classList.remove('hidden'); loadWrkVacancies(); }
}

function empTab(tab, btn) {
  document.querySelectorAll('#employerScreen .tab-btn').forEach(b => b.classList.remove('active'));
  if(btn) btn.classList.add('active');
  ['empVacanciesTab','empCandidatesTab','empIncomingTab','empProfileTab'].forEach(id => document.getElementById(id).classList.add('hidden'));
  const labels = {vacancies:'–ú–æ–∏ –≤–∞–∫–∞–Ω—Å–∏–∏',candidates:'–ö–∞–Ω–¥–∏–¥–∞—Ç—ã',incoming:'–í—Ö–æ–¥—è—â–∏–µ –æ—Ç–∫–ª–∏–∫–∏',profile:'–ü—Ä–æ—Ñ–∏–ª—å –∫–æ–º–ø–∞–Ω–∏–∏'};
  document.getElementById('empTabLabel').textContent = labels[tab] || tab;
  if(tab==='vacancies') { document.getElementById('empVacanciesTab').classList.remove('hidden'); loadEmpVacancies(); }
  else if(tab==='candidates') { document.getElementById('empCandidatesTab').classList.remove('hidden'); loadCandidates(); }
  else if(tab==='incoming') { document.getElementById('empIncomingTab').classList.remove('hidden'); loadIncoming(); }
  else if(tab==='profile') { document.getElementById('empProfileTab').classList.remove('hidden'); loadEmpProfile(); }
}
function wrkTab(tab, btn) {
  document.querySelectorAll('#workerScreen .tab-btn').forEach(b => b.classList.remove('active'));
  if(btn) btn.classList.add('active');
  ['wrkVacanciesTab','wrkProfileTab'].forEach(id => document.getElementById(id).classList.add('hidden'));
  document.getElementById('wrkTabLabel').textContent = tab==='vacancies' ? '–í–∞–∫–∞–Ω—Å–∏–∏' : '–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å';
  if(tab==='vacancies') { document.getElementById('wrkVacanciesTab').classList.remove('hidden'); loadWrkVacancies(); }
  else { document.getElementById('wrkProfileTab').classList.remove('hidden'); loadWrkProfile(); }
}

// ‚îÄ‚îÄ EMPLOYER VACANCIES ‚îÄ‚îÄ
async function loadEmpVacancies() {
  const el = document.getElementById('empVacList');
  el.innerHTML = '<div class="loading"><div class="spin"></div>–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
  const all = await sbList('vacancies', 'vac_');
  const mine = all.filter(v => v.eid === UID);
  if(!mine.length) { el.innerHTML = `<div class="empty"><div class="empty-ico">üìã</div><div class="empty-title">–ù–µ—Ç –≤–∞–∫–∞–Ω—Å–∏–π</div><div class="empty-text">–ù–∞–∂–º–∏—Ç–µ + —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—É—é –≤–∞–∫–∞–Ω—Å–∏—é</div></div>`; return; }
  const allResp = await sbList('responses', 'resp_');
  const ratings = {};
  for(const v of mine) { const r = await sbGet('ratings', 'rating_' + v.eid); if(r) ratings[v.eid] = r; }
  el.innerHTML = mine.map(v => {
    const rc = allResp.filter(r => r.vid === v.id).length;
    const rat = ratings[v.eid];
    const sc = {active:'status-active',paused:'status-paused',closed:'status-closed'}[v.status||'active'];
    const st = {active:'–ê–∫—Ç–∏–≤–Ω–∞',paused:'–ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞',closed:'–ó–∞–∫—Ä—ã—Ç–∞'}[v.status||'active'];
    return `<div class="vcard" onclick="openVacancy('${v.id}','employer')">
      <div class="vcard-top">
        <div class="vcard-head"><div class="vcard-title">${v.specialty}</div><button class="vcard-fav" onclick="toggleFav('v','${v.id}',event)">${isFav('v',v.id)?'‚ù§Ô∏è':'ü§ç'}</button></div>
        <div class="vcard-company">${v.companyName||UNAME} ${v.verified?'‚úÖ':''} ${rat&&rat.cnt?starsSmall(rat.avg,rat.cnt):''}</div>
        <div class="vcard-salary">${salStr(v.salFrom,v.salTo)}</div>
        <div class="vcard-tags">
          <span class="vtag vtag-blue">üìç ${v.region}</span>
          <span class="vtag">üìÖ ${v.schedule}</span>
          ${v.workSchedule?`<span class="vtag vtag-orange">‚è∞ ${v.workSchedule}</span>`:''}
          <span class="${sc}">${st}</span>
        </div>
      </div>
      ${v.shortDesc?`<div class="vcard-desc">${v.shortDesc}</div>`:''}
      <div class="vcard-footer"><span class="vcard-date">${timeAgo(v.createdAt)}</span><span class="vcard-responses">üë• ${rc} –æ—Ç–∫–ª–∏–∫–æ–≤</span></div>
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ CREATE / EDIT VACANCY ‚îÄ‚îÄ
async function showCreateVacancy(editId) {
  const profile = await sbGet('profiles', 'emp_' + UID);
  if(!profile || !profile.companyName) { toast('–°–Ω–∞—á–∞–ª–∞ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å –∫–æ–º–ø–∞–Ω–∏–∏!'); empTab('profile', document.querySelectorAll('#employerScreen .tab-btn')[3]); return; }
  let ev = null;
  if(editId) { ev = await sbGet('vacancies', editId); }
  const specVal = ev ? (SPECS.includes(ev.specialty) ? ev.specialty : 'custom') : '';
  const schedVal = ev ? (SCHEDS.includes(ev.schedule) ? ev.schedule : '–î—Ä—É–≥–æ–π –≥—Ä–∞—Ñ–∏–∫') : '';
  openModal(`
    <div class="modal-handle"></div>
    <div class="modal-title">${editId ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å' : '–ù–æ–≤–∞—è'} –≤–∞–∫–∞–Ω—Å–∏—è</div>
    <div class="modal-sub">–æ—Ç ${profile.companyName}</div>
    <form onsubmit="submitVacancy(event,'${editId||''}')">
    <div class="form-wrap">
      <div class="fg"><label>–°–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å<span class="req">*</span></label>
        <select id="vSpec" required onchange="toggleCustomSpec()">
          <option value="">–í—ã–±–µ—Ä–∏—Ç–µ...</option>
          ${SPECS.map(s=>`<option value="${s}" ${specVal===s?'selected':''}>${s}</option>`).join('')}
          <option value="custom" ${specVal==='custom'?'selected':''}>–î—Ä—É–≥–æ–µ</option>
        </select></div>
      <div class="fg ${specVal==='custom'?'':'hidden'}" id="vSpecCustomWrap"><label>–£–∫–∞–∂–∏—Ç–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å<span class="req">*</span></label><input type="text" id="vSpecCustom" value="${ev&&!SPECS.includes(ev.specialty)?ev.specialty:''}"></div>
      <div class="fg"><label>–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ</label><input type="text" id="vShortDesc" value="${ev?.shortDesc||''}" placeholder="–í–∏–¥–Ω–æ –≤ —Å–ø–∏—Å–∫–µ –≤–∞–∫–∞–Ω—Å–∏–π"></div>
      <div class="fg-row">
        <div class="fg"><label>–ó–ü –æ—Ç (‚ÇΩ)<span class="req">*</span></label><input type="number" id="vSalFrom" value="${ev?.salFrom||''}" required></div>
        <div class="fg"><label>–ó–ü –¥–æ (‚ÇΩ)</label><input type="number" id="vSalTo" value="${ev?.salTo||''}"></div>
      </div>
      <div class="fg"><label>–û–±—ä–µ–∫—Ç<span class="req">*</span></label><input type="text" id="vObject" value="${ev?.object||''}" required></div>
      <div class="fg"><label>–†–µ–≥–∏–æ–Ω<span class="req">*</span></label><input type="text" id="vRegion" value="${ev?.region||''}" required></div>
      <div class="fg"><label>–ì—Ä–∞—Ñ–∏–∫ –≤–∞—Ö—Ç—ã<span class="req">*</span></label>
        <select id="vSchedule" required onchange="toggleCustomSchedule()">
          <option value="">–í—ã–±–µ—Ä–∏—Ç–µ...</option>
          ${SCHEDS.map(s=>`<option value="${s}" ${schedVal===s?'selected':''}>${s}</option>`).join('')}
        </select></div>
      <div class="fg ${schedVal==='–î—Ä—É–≥–æ–π –≥—Ä–∞—Ñ–∏–∫'?'':'hidden'}" id="vScheduleCustomWrap"><label>–£–∫–∞–∂–∏—Ç–µ –≥—Ä–∞—Ñ–∏–∫</label><input type="text" id="vScheduleCustom" value="${ev&&!SCHEDS.includes(ev.schedule)?ev.schedule:''}" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 20/10"></div>
      <div class="fg"><label>–ì—Ä–∞—Ñ–∏–∫ —Å–º–µ–Ω</label><input type="text" id="vWorkSchedule" value="${ev?.workSchedule||''}" placeholder="12/12, 8/8, –¥–Ω–µ–≤–Ω—ã–µ..."></div>
      <div class="fg"><label>–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∏ –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏</label><textarea id="vDesc">${ev?.desc||''}</textarea></div>
      <div class="fg"><label>–ü—Ä–æ–∂–∏–≤–∞–Ω–∏–µ</label><textarea id="vHousing">${ev?.housing||''}</textarea></div>
      <div class="fg"><label>–ü–∏—Ç–∞–Ω–∏–µ</label><textarea id="vFood">${ev?.food||''}</textarea></div>
      <div class="fg"><label>–°–ø–µ—Ü–æ–¥–µ–∂–¥–∞</label><textarea id="vClothing">${ev?.clothing||''}</textarea></div>
      <div class="fg"><label>–ü—Ä–æ–µ–∑–¥ –¥–æ –æ–±—ä–µ–∫—Ç–∞</label><textarea id="vTransport">${ev?.transport||''}</textarea></div>
      <div class="toggle-row"><span class="toggle-label">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω –∫–æ–º–ø–∞–Ω–∏–∏</span><button type="button" class="toggle ${ev?.showPhone?'on':''}" id="vShowPhone" onclick="this.classList.toggle('on')"></button></div>
      <button type="submit" class="btn btn-primary">${editId ? '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è' : '–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –≤–∞–∫–∞–Ω—Å–∏—é'}</button>
    </div></form>`);
}
function toggleCustomSpec() { const v = document.getElementById('vSpec').value; document.getElementById('vSpecCustomWrap').classList.toggle('hidden', v!=='custom'); }
function toggleCustomSchedule() { const v = document.getElementById('vSchedule').value; document.getElementById('vScheduleCustomWrap').classList.toggle('hidden', v!=='–î—Ä—É–≥–æ–π –≥—Ä–∞—Ñ–∏–∫'); }

async function submitVacancy(e, editId) {
  e.preventDefault();
  const profile = await sbGet('profiles', 'emp_' + UID);
  let spec = document.getElementById('vSpec').value; if(spec==='custom') spec = document.getElementById('vSpecCustom').value;
  let sched = document.getElementById('vSchedule').value; if(sched==='–î—Ä—É–≥–æ–π –≥—Ä–∞—Ñ–∏–∫') sched = document.getElementById('vScheduleCustom').value;
  const id = editId || ('vac_' + Date.now());
  const existing = editId ? await sbGet('vacancies', editId) : null;
  const v = {
    id, eid: UID, companyName: profile.companyName, verified: isVerified(profile),
    specialty: spec, shortDesc: document.getElementById('vShortDesc').value,
    salFrom: document.getElementById('vSalFrom').value, salTo: document.getElementById('vSalTo').value,
    object: document.getElementById('vObject').value, region: document.getElementById('vRegion').value,
    schedule: sched, workSchedule: document.getElementById('vWorkSchedule').value,
    desc: document.getElementById('vDesc').value, housing: document.getElementById('vHousing').value,
    food: document.getElementById('vFood').value, clothing: document.getElementById('vClothing').value,
    transport: document.getElementById('vTransport').value,
    showPhone: document.getElementById('vShowPhone').classList.contains('on'),
    status: existing?.status || 'active',
    createdAt: existing?.createdAt || new Date().toISOString()
  };
  await sbSet('vacancies', id, v);
  closeModal(); toast(editId ? '–í–∞–∫–∞–Ω—Å–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞! ‚úÖ' : '–í–∞–∫–∞–Ω—Å–∏—è –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞! ‚úÖ');
  loadEmpVacancies();
}

async function deleteVacancy(vid) {
  if(!confirm('–£–¥–∞–ª–∏—Ç—å –≤–∞–∫–∞–Ω—Å–∏—é?')) return;
  await sbDelete('vacancies', vid);
  closeModal(); toast('–í–∞–∫–∞–Ω—Å–∏—è —É–¥–∞–ª–µ–Ω–∞'); loadEmpVacancies();
}
async function pauseVacancy(vid) {
  const v = await sbGet('vacancies', vid); if(!v) return;
  const newStatus = v.status === 'paused' ? 'active' : 'paused';
  v.status = newStatus; await sbSet('vacancies', vid, v);
  closeModal(); toast(newStatus==='paused' ? '–í–∞–∫–∞–Ω—Å–∏—è –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞' : '–í–∞–∫–∞–Ω—Å–∏—è –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∞! ‚úÖ');
  loadEmpVacancies();
}

// ‚îÄ‚îÄ CANDIDATES ‚îÄ‚îÄ
async function loadCandidates() {
  const el = document.getElementById('empCandList');
  el.innerHTML = '<div class="loading"><div class="spin"></div>–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
  allCandsCache = await sbList('profiles', 'wrk_');
  buildCandFilters(); renderCands(allCandsCache);
}
function buildCandFilters() {
  const specs = [...new Set(allCandsCache.map(c => c.specialty).filter(Boolean))];
  const el = document.getElementById('candFilters');
  el.innerHTML = `<div class="fchip on" onclick="filterCandidates(this,'spec','')">–í—Å–µ</div>` +
    specs.map(s => `<div class="fchip" onclick="filterCandidates(this,'spec','${s}')">${s}</div>`).join('') +
    `<div class="fchip" onclick="filterCandidates(this,'exp','–ë–µ–∑ –æ–ø—ã—Ç–∞')">–ë–µ–∑ –æ–ø—ã—Ç–∞</div>` +
    `<div class="fchip" onclick="filterCandidates(this,'exp','1‚Äì3 –≥–æ–¥–∞')">1‚Äì3 –≥–æ–¥–∞</div>` +
    `<div class="fchip" onclick="filterCandidates(this,'exp','3‚Äì5 –ª–µ—Ç')">3‚Äì5 –ª–µ—Ç</div>` +
    `<div class="fchip" onclick="filterCandidates(this,'exp','5+ –ª–µ—Ç')">5+ –ª–µ—Ç</div>`;
}
function filterCandidates(chip, type, val) {
  if(chip) { document.querySelectorAll('#candFilters .fchip').forEach(c => c.classList.remove('on')); chip.classList.add('on'); }
  const search = document.getElementById('candSearch').value.toLowerCase();
  let res = allCandsCache;
  if(type==='spec' && val) res = res.filter(c => c.specialty === val);
  if(type==='exp' && val) res = res.filter(c => expRange(c.experience) === val);
  if(search) res = res.filter(c => `${c.name} ${c.specialty} ${c.about||''} ${c.region||''}`.toLowerCase().includes(search));
  renderCands(res);
}
function renderCands(list) {
  const el = document.getElementById('empCandList');
  if(!list.length) { el.innerHTML = `<div class="empty"><div class="empty-ico">üë•</div><div class="empty-title">–ö–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –Ω–µ—Ç</div></div>`; return; }
  el.innerHTML = list.map(c => {
    const avatar = c.photo ? `<img src="${c.photo}" class="avatar-circle" style="width:44px;height:44px;flex-shrink:0">` : `<div style="width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0">üë§</div>`;
    return `<div class="vcard" onclick="openCandidate('${c.uid}')">
      <div class="vcard-top">
        <div class="vcard-head">
          <div style="display:flex;align-items:center;gap:10px;flex:1">
            ${avatar}
            <div><div class="vcard-title">${c.name}</div><div class="vcard-company">${c.specialty}</div></div>
          </div>
          <button class="vcard-fav" onclick="toggleFav('c','${c.uid}',event)">${isFav('c',c.uid)?'‚ù§Ô∏è':'ü§ç'}</button>
        </div>
        <div class="vcard-tags">
          <span class="vtag vtag-green">üìä ${c.experience} ${yrs(c.experience)}</span>
          <span class="vtag vtag-blue">üìç ${c.region||'‚Äî'}</span>
          <span class="vtag">${expRange(c.experience)}</span>
        </div>
        ${c.about?`<div style="font-size:13px;color:var(--text2);margin-top:6px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden">${c.about}</div>`:''}
      </div>
      <div class="vcard-footer"><span class="vcard-date">üìû ${c.phone}</span></div>
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ INCOMING ‚îÄ‚îÄ
async function loadIncoming() {
  const el = document.getElementById('empIncomingList');
  el.innerHTML = '<div class="loading"><div class="spin"></div>–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
  const allResp = await sbList('responses', 'resp_');
  const allVacs = await sbList('vacancies', 'vac_');
  const myVacIds = allVacs.filter(v => v.eid === UID).map(v => v.id);
  const mine = allResp.filter(r => myVacIds.includes(r.vid));
  if(!mine.length) { el.innerHTML = `<div class="empty"><div class="empty-ico">üì¨</div><div class="empty-title">–û—Ç–∫–ª–∏–∫–æ–≤ –Ω–µ—Ç</div><div class="empty-text">–ö–æ–≥–¥–∞ —Å–æ–∏—Å–∫–∞—Ç–µ–ª–∏ –æ—Ç–∫–ª–∏–∫–Ω—É—Ç—Å—è ‚Äî –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å</div></div>`; return; }
  const profiles = await sbList('profiles', 'wrk_');
  const vacs = await sbList('vacancies', 'vac_');
  el.innerHTML = mine.map(r => {
    const prof = profiles.find(p => p.uid === r.wid);
    const vac = vacs.find(v => v.id === r.vid);
    if(!prof || !vac) return '';
    const avatar = prof.photo ? `<img src="${prof.photo}" style="width:40px;height:40px;border-radius:50%;object-fit:cover;flex-shrink:0">` : `<div style="width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0">üë§</div>`;
    return `<div class="vcard" onclick="openCandidate('${prof.uid}')">
      <div class="vcard-top">
        <div style="display:flex;align-items:center;gap:10px">
          ${avatar}
          <div><div class="vcard-title">${prof.name}</div><div class="vcard-company">–û—Ç–∫–ª–∏–∫ –Ω–∞: ${vac.specialty}</div></div>
        </div>
        <div class="vcard-tags" style="margin-top:8px">
          <span class="vtag vtag-green">üìä ${prof.experience} ${yrs(prof.experience)}</span>
          <span class="vtag vtag-blue">üìç ${prof.region||'‚Äî'}</span>
        </div>
      </div>
      <div class="vcard-footer"><span class="vcard-date">üìû ${prof.phone}</span><span class="vcard-date">${timeAgo(r.createdAt)}</span></div>
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ EMPLOYER PROFILE ‚îÄ‚îÄ
async function loadEmpProfile() {
  const el = document.getElementById('empProfileView');
  const profile = await sbGet('profiles', 'emp_' + UID);
  if(!profile) {
    el.innerHTML = `<div class="empty"><div class="empty-ico">üè¢</div><div class="empty-title">–ü—Ä–æ—Ñ–∏–ª—å –∫–æ–º–ø–∞–Ω–∏–∏</div><div class="empty-text">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å —á—Ç–æ–±—ã –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –≤–∞–∫–∞–Ω—Å–∏–∏. –ü–æ–ª–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—É—á–∞–µ—Ç –∑–Ω–∞—á–æ–∫ ‚úÖ</div><button class="btn btn-primary" style="margin:0 20px;width:calc(100% - 40px)" onclick="showEmpProfileForm()">–ó–∞–ø–æ–ª–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button></div>`;
    return;
  }
  const verified = isVerified(profile);
  const rating = await sbGet('ratings', 'rating_' + UID) || {avg:0,cnt:0};
  const avatarHtml = profile.photo ? `<img src="${profile.photo}" class="avatar-circle" style="margin:0 auto">` : `<div class="avatar-placeholder">üè¢</div>`;
  el.innerHTML = `
    <div class="profile-hero">
      ${avatarHtml}
      <div class="profile-name">${profile.companyName} ${verified?'‚úÖ':''}</div>
      <div class="profile-role">${profile.sphere||'–°—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ / –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ'}</div>
      ${rating.cnt?`<div style="margin-top:6px">${starsHtml(rating.avg,rating.cnt)}</div>`:''}
    </div>
    <div class="form-wrap">
      <div class="detail-section">
        <div class="detail-section-title">–†–µ–∫–≤–∏–∑–∏—Ç—ã</div>
        <div class="detail-row"><span class="detail-ico">üìã</span><div class="detail-info"><div class="detail-label">–ò–ù–ù</div><div class="detail-value">${profile.inn||'‚Äî'}</div></div></div>
        <div class="detail-row"><span class="detail-ico">üìç</span><div class="detail-info"><div class="detail-label">–Æ—Ä. –∞–¥—Ä–µ—Å</div><div class="detail-value">${profile.address||'‚Äî'}</div></div></div>
        ${profile.phone?`<div class="detail-row"><span class="detail-ico">üìû</span><div class="detail-info"><div class="detail-label">–¢–µ–ª–µ—Ñ–æ–Ω</div><div class="detail-value">${profile.phone}</div></div></div>`:''}
        ${profile.email?`<div class="detail-row"><span class="detail-ico">‚úâÔ∏è</span><div class="detail-info"><div class="detail-label">Email</div><div class="detail-value">${profile.email}</div></div></div>`:''}
      </div>
      ${profile.about?`<div class="detail-section"><div class="detail-section-title">–û –∫–æ–º–ø–∞–Ω–∏–∏</div><p style="font-size:14px;line-height:1.6;color:var(--text2)">${profile.about}</p></div>`:''}
      <button class="btn btn-outline" onclick="showEmpProfileForm()">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
    </div>`;
}
function showEmpProfileForm() {
  openModal(`<div class="modal-handle"></div><div class="modal-title">–ü—Ä–æ—Ñ–∏–ª—å –∫–æ–º–ø–∞–Ω–∏–∏</div>
    <form onsubmit="submitEmpProfile(event)"><div class="form-wrap">
      <div class="fg"><label>–§–æ—Ç–æ / –ª–æ–≥–æ—Ç–∏–ø</label>
        <div class="photo-upload-area" onclick="document.getElementById('empPhotoInput').click()">
          <img id="empPhotoPreview" class="photo-preview" style="display:none">
          <div id="empPhotoPlaceholder">üì∑ –ù–∞–∂–º–∏—Ç–µ —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å</div>
          <input type="file" id="empPhotoInput" accept="image/*" style="display:none" onchange="previewPhoto('empPhotoInput','empPhotoPreview','empPhotoPlaceholder')">
        </div>
      </div>
      <div class="fg"><label>–ù–∞–∑–≤–∞–Ω–∏–µ<span class="req">*</span></label><input type="text" id="epName" required></div>
      <div class="fg"><label>–ò–ù–ù<span class="req">*</span></label><input type="text" id="epInn" required></div>
      <div class="fg"><label>–Æ—Ä. –∞–¥—Ä–µ—Å<span class="req">*</span></label><input type="text" id="epAddr" required></div>
      <div class="fg"><label>–°—Ñ–µ—Ä–∞ –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏</label><input type="text" id="epSphere"></div>
      <div class="fg"><label>–¢–µ–ª–µ—Ñ–æ–Ω</label><input type="tel" id="epPhone"></div>
      <div class="fg"><label>Email</label><input type="email" id="epEmail"></div>
      <div class="fg"><label>–û –∫–æ–º–ø–∞–Ω–∏–∏<span class="req">*</span></label><textarea id="epAbout" required></textarea></div>
      <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div></form>`);
}
async function submitEmpProfile(e) {
  e.preventDefault();
  const photo = await getPhotoData('empPhotoInput');
  const p = { uid: UID, companyName: document.getElementById('epName').value, inn: document.getElementById('epInn').value, address: document.getElementById('epAddr').value, sphere: document.getElementById('epSphere').value, phone: document.getElementById('epPhone').value, email: document.getElementById('epEmail').value, about: document.getElementById('epAbout').value, photo };
  await sbSet('profiles', 'emp_' + UID, p);
  closeModal(); toast('–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω! ‚úÖ'); loadEmpProfile();
}

// ‚îÄ‚îÄ WORKER VACANCIES ‚îÄ‚îÄ
async function loadWrkVacancies() {
  const el = document.getElementById('wrkVacList');
  el.innerHTML = '<div class="loading"><div class="spin"></div>–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
  allVacsCache = await sbList('vacancies', 'vac_');
  allVacsCache = allVacsCache.filter(v => v.status !== 'closed' && v.status !== 'paused');
  await buildVacFilters(); renderVacs(allVacsCache);
}
async function buildVacFilters() {
  const specs = [...new Set(allVacsCache.map(v => v.specialty).filter(Boolean))];
  const el = document.getElementById('vacFilters');
  el.innerHTML = `<div class="fchip on" onclick="filterVacancies(this,'spec','')">–í—Å–µ</div>` +
    specs.map(s => `<div class="fchip" onclick="filterVacancies(this,'spec','${s}')">${s}</div>`).join('') +
    `<div class="fchip" onclick="filterVacancies(this,'sal','50')">–æ—Ç 50–∫</div>` +
    `<div class="fchip" onclick="filterVacancies(this,'sal','100')">–æ—Ç 100–∫</div>` +
    `<div class="fchip" onclick="filterVacancies(this,'sal','150')">–æ—Ç 150–∫</div>`;
}
function filterVacancies(chip, type, val) {
  if(chip) { document.querySelectorAll('#vacFilters .fchip').forEach(c => c.classList.remove('on')); chip.classList.add('on'); }
  const search = document.getElementById('vacSearch').value.toLowerCase();
  let res = allVacsCache;
  if(type==='spec' && val) res = res.filter(v => v.specialty === val);
  if(type==='sal' && val) res = res.filter(v => parseInt(v.salFrom||0) >= parseInt(val)*1000);
  if(search) res = res.filter(v => `${v.specialty} ${v.region} ${v.object} ${v.shortDesc||''} ${v.desc||''}`.toLowerCase().includes(search));
  renderVacs(res);
}
async function renderVacs(list) {
  const el = document.getElementById('wrkVacList');
  if(!list.length) { el.innerHTML = `<div class="empty"><div class="empty-ico">üíº</div><div class="empty-title">–í–∞–∫–∞–Ω—Å–∏–π –Ω–µ—Ç</div></div>`; return; }
  const ratingsCache = {};
  el.innerHTML = await Promise.all(list.map(async v => {
    let rat = ratingsCache[v.eid];
    if(!rat) { rat = await sbGet('ratings','rating_'+v.eid)||{avg:0,cnt:0}; ratingsCache[v.eid]=rat; }
    return `<div class="vcard" onclick="openVacancy('${v.id}','worker')">
      <div class="vcard-top">
        <div class="vcard-head"><div class="vcard-title">${v.specialty}</div><button class="vcard-fav" onclick="toggleFav('v','${v.id}',event)">${isFav('v',v.id)?'‚ù§Ô∏è':'ü§ç'}</button></div>
        <div class="vcard-company">${v.companyName} ${v.verified?'‚úÖ':''} ${rat&&rat.cnt?starsSmall(rat.avg,rat.cnt):''}</div>
        <div class="vcard-salary">${salStr(v.salFrom,v.salTo)}</div>
        <div class="vcard-tags">
          <span class="vtag vtag-blue">üìç ${v.region}</span>
          <span class="vtag">üìÖ ${v.schedule}</span>
          ${v.workSchedule?`<span class="vtag vtag-orange">‚è∞ ${v.workSchedule}</span>`:''}
        </div>
      </div>
      ${v.shortDesc?`<div class="vcard-desc">${v.shortDesc}</div>`:''}
      <div class="vcard-footer"><span class="vcard-date">${timeAgo(v.createdAt)}</span></div>
    </div>`;
  })).then(r => r.join(''));
}

// ‚îÄ‚îÄ WORKER PROFILE ‚îÄ‚îÄ
async function loadWrkProfile() {
  const el = document.getElementById('wrkProfileView');
  const p = await sbGet('profiles', 'wrk_' + UID);
  if(!p) {
    el.innerHTML = `<div class="empty"><div class="empty-ico">üë§</div><div class="empty-title">–°–æ–∑–¥–∞–π—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å</div><div class="empty-text">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å —á—Ç–æ–±—ã —Ä–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª–∏ –º–æ–≥–ª–∏ –Ω–∞–π—Ç–∏ –≤–∞—Å</div><button class="btn btn-primary" style="margin:0 20px;width:calc(100% - 40px)" onclick="showWrkProfileForm()">–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button></div>`;
    return;
  }
  const avatarHtml = p.photo ? `<img src="${p.photo}" class="avatar-circle" style="margin:0 auto">` : `<div class="avatar-placeholder">üë∑</div>`;
  el.innerHTML = `
    <div class="profile-hero">
      ${avatarHtml}
      <div class="profile-name">${p.name}</div>
      <div class="profile-role">${p.specialty}</div>
    </div>
    <div class="form-wrap">
      <div class="detail-section">
        <div class="detail-section-title">–ö–æ–Ω—Ç–∞–∫—Ç—ã –∏ –¥–∞–Ω–Ω—ã–µ</div>
        <div class="detail-row"><span class="detail-ico">üìû</span><div class="detail-info"><div class="detail-label">–¢–µ–ª–µ—Ñ–æ–Ω</div><div class="detail-value">${p.phone}</div></div></div>
        <div class="detail-row"><span class="detail-ico">üìä</span><div class="detail-info"><div class="detail-label">–û–ø—ã—Ç —Ä–∞–±–æ—Ç—ã</div><div class="detail-value">${p.experience} ${yrs(p.experience)}</div></div></div>
        <div class="detail-row"><span class="detail-ico">üìç</span><div class="detail-info"><div class="detail-label">–†–µ–≥–∏–æ–Ω</div><div class="detail-value">${p.region||'‚Äî'}</div></div></div>
        ${p.tg?`<div class="detail-row"><span class="detail-ico">‚úàÔ∏è</span><div class="detail-info"><div class="detail-label">Telegram</div><div class="detail-value">@${p.tg}</div></div></div>`:''}
      </div>
      ${p.about?`<div class="detail-section"><div class="detail-section-title">–û —Å–µ–±–µ –∏ –Ω–∞–≤—ã–∫–∏</div><p style="font-size:14px;line-height:1.6;color:var(--text2)">${p.about}</p></div>`:''}
      ${p.docs?`<div class="detail-section"><div class="detail-section-title">–î–æ–∫—É–º–µ–Ω—Ç—ã –∏ –¥–æ–ø—É—Å–∫–∏</div><p style="font-size:14px;line-height:1.6;color:var(--text2)">${p.docs}</p></div>`:''}
      <div class="btn-row">
        <button class="btn btn-outline" onclick="showWrkProfileForm()">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
        <button class="btn btn-danger btn-sm" onclick="deleteWrkProfile()">üóë –£–¥–∞–ª–∏—Ç—å</button>
      </div>
    </div>`;
}
function showWrkProfileForm() {
  openModal(`<div class="modal-handle"></div><div class="modal-title">–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</div>
    <form onsubmit="submitWrkProfile(event)"><div class="form-wrap">
      <div class="fg"><label>–§–æ—Ç–æ</label>
        <div class="photo-upload-area" onclick="document.getElementById('wrkPhotoInput').click()">
          <img id="wrkPhotoPreview" class="photo-preview" style="display:none">
          <div id="wrkPhotoPlaceholder">üì∑ –ù–∞–∂–º–∏—Ç–µ —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å</div>
          <input type="file" id="wrkPhotoInput" accept="image/*" style="display:none" onchange="previewPhoto('wrkPhotoInput','wrkPhotoPreview','wrkPhotoPlaceholder')">
        </div>
      </div>
      <div class="fg"><label>–§–ò–û<span class="req">*</span></label><input type="text" id="wpName" required></div>
      <div class="fg"><label>–¢–µ–ª–µ—Ñ–æ–Ω<span class="req">*</span></label><input type="tel" id="wpPhone" required></div>
      <div class="fg"><label>–°–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å<span class="req">*</span></label>
        <select id="wpSpec" required onchange="toggleWrkCustomSpec()">
          <option value="">–í—ã–±–µ—Ä–∏—Ç–µ...</option>
          ${SPECS.map(s=>`<option value="${s}">${s}</option>`).join('')}
          <option value="custom">–î—Ä—É–≥–æ–µ</option>
        </select></div>
      <div class="fg hidden" id="wpSpecCustomWrap"><label>–£–∫–∞–∂–∏—Ç–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å<span class="req">*</span></label><input type="text" id="wpSpecCustom"></div>
      <div class="fg-row">
        <div class="fg"><label>–û–ø—ã—Ç (–ª–µ—Ç)<span class="req">*</span></label><input type="number" id="wpExp" min="0" required></div>
        <div class="fg"><label>–†–µ–≥–∏–æ–Ω<span class="req">*</span></label><input type="text" id="wpRegion" required></div>
      </div>
      <div class="fg"><label>Telegram username</label><input type="text" id="wpTg" placeholder="username (–±–µ–∑ @)"></div>
      <div class="fg"><label>–û —Å–µ–±–µ –∏ –Ω–∞–≤—ã–∫–∏<span class="req">*</span></label><textarea id="wpAbout" required></textarea></div>
      <div class="fg"><label>–î–æ–∫—É–º–µ–Ω—Ç—ã –∏ –¥–æ–ø—É—Å–∫–∏</label><textarea id="wpDocs"></textarea></div>
      <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
    </div></form>`);
}
function toggleWrkCustomSpec() { const v = document.getElementById('wpSpec').value; document.getElementById('wpSpecCustomWrap').classList.toggle('hidden', v!=='custom'); }
async function submitWrkProfile(e) {
  e.preventDefault();
  let spec = document.getElementById('wpSpec').value; if(spec==='custom') spec = document.getElementById('wpSpecCustom').value;
  const photo = await getPhotoData('wrkPhotoInput');
  const p = { uid: UID, name: document.getElementById('wpName').value, phone: document.getElementById('wpPhone').value, specialty: spec, experience: parseInt(document.getElementById('wpExp').value), region: document.getElementById('wpRegion').value, tg: document.getElementById('wpTg').value||TG_USERNAME||'', about: document.getElementById('wpAbout').value, docs: document.getElementById('wpDocs').value, photo };
  await sbSet('profiles', 'wrk_' + UID, p);
  closeModal(); toast('–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω! ‚úÖ'); loadWrkProfile();
}
async function deleteWrkProfile() {
  if(!confirm('–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å?')) return;
  await sbDelete('profiles', 'wrk_' + UID);
  toast('–ü—Ä–æ—Ñ–∏–ª—å —É–¥–∞–ª—ë–Ω'); loadWrkProfile();
}

// ‚îÄ‚îÄ PHOTO UTILS ‚îÄ‚îÄ
function previewPhoto(inputId, previewId, placeholderId) {
  const input = document.getElementById(inputId);
  const file = input.files[0]; if(!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    const preview = document.getElementById(previewId);
    preview.src = e.target.result; preview.style.display = 'block';
    document.getElementById(placeholderId).style.display = 'none';
  };
  reader.readAsDataURL(file);
}
async function getPhotoData(inputId) {
  return new Promise(resolve => {
    const input = document.getElementById(inputId);
    if(!input || !input.files[0]) { resolve(null); return; }
    const reader = new FileReader();
    reader.onload = e => resolve(e.target.result);
    reader.readAsDataURL(input.files[0]);
  });
}

// ‚îÄ‚îÄ OPEN VACANCY DETAIL ‚îÄ‚îÄ
async function openVacancy(vid, viewAs) {
  const v = await sbGet('vacancies', vid); if(!v) return;
  const profile = await sbGet('profiles', 'emp_' + v.eid);
  const rating = await sbGet('ratings', 'rating_' + v.eid) || {avg:0,cnt:0};
  const allResp = await sbList('responses', 'resp_');
  const rc = allResp.filter(r => r.vid === vid).length;
  const myResp = allResp.find(r => r.vid === vid && r.wid === UID);
  const companyAvatar = profile?.photo ? `<img src="${profile.photo}" style="width:48px;height:48px;border-radius:50%;object-fit:cover">` : `<div style="width:48px;height:48px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-size:22px">üè¢</div>`;

  let actions = '';
  if(viewAs === 'worker') {
    if(myResp) actions = `<button class="btn btn-outline" disabled>‚úÖ –í—ã —É–∂–µ –æ—Ç–∫–ª–∏–∫–Ω—É–ª–∏—Å—å</button>`;
    else actions = `<button class="btn btn-primary" onclick="sendResponse('${vid}')">üì© –û—Ç–∫–ª–∏–∫–Ω—É—Ç—å—Å—è –Ω–∞ –≤–∞–∫–∞–Ω—Å–∏—é</button>`;
    if(profile?.phone && v.showPhone) {
      actions += `<div class="btn-row"><a href="tel:${profile.phone}" class="btn btn-green" style="text-decoration:none">üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å</a>${profile?.tg?`<a href="https://t.me/${profile.tg}" class="btn btn-blue" style="text-decoration:none" target="_blank">‚úàÔ∏è –ù–∞–ø–∏—Å–∞—Ç—å</a>`:''}</div>`;
    }
  } else if(viewAs === 'employer') {
    const isPaused = v.status === 'paused';
    actions = `<div class="btn-row3">
      <button class="btn btn-outline btn-sm" onclick="showCreateVacancy('${vid}')">‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å</button>
      <button class="btn btn-warn btn-sm" onclick="pauseVacancy('${vid}')">${isPaused?'‚ñ∂Ô∏è –í–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å':'‚è∏ –ü–∞—É–∑–∞'}</button>
      <button class="btn btn-danger btn-sm" onclick="deleteVacancy('${vid}')">üóë –£–¥–∞–ª–∏—Ç—å</button>
    </div>`;
  }

  openModal(`
    <div class="modal-handle"></div>
    <div style="display:flex;gap:12px;align-items:start;margin-bottom:12px">
      ${companyAvatar}
      <div style="flex:1">
        <div class="modal-title" style="font-size:16px;margin-bottom:2px">${v.specialty}</div>
        <div style="font-size:13px;color:var(--text2)">${v.companyName} ${v.verified?'‚úÖ':''}</div>
        ${rating.cnt?starsHtml(rating.avg,rating.cnt):''}
      </div>
      <button class="vcard-fav" onclick="toggleFav('v','${vid}',event)">${isFav('v',vid)?'‚ù§Ô∏è':'ü§ç'}</button>
    </div>
    <div style="font-size:24px;font-weight:700;color:var(--green);margin-bottom:16px">${salStr(v.salFrom,v.salTo)}</div>
    <div class="detail-section">
      <div class="detail-row"><span class="detail-ico">üìç</span><div class="detail-info"><div class="detail-label">–†–µ–≥–∏–æ–Ω</div><div class="detail-value">${v.region}</div></div></div>
      <div class="detail-row"><span class="detail-ico">üè¢</span><div class="detail-info"><div class="detail-label">–û–±—ä–µ–∫—Ç</div><div class="detail-value">${v.object}</div></div></div>
      <div class="detail-row"><span class="detail-ico">üìÖ</span><div class="detail-info"><div class="detail-label">–ì—Ä–∞—Ñ–∏–∫ –≤–∞—Ö—Ç—ã</div><div class="detail-value">${v.schedule}</div></div></div>
      ${v.workSchedule?`<div class="detail-row"><span class="detail-ico">‚è∞</span><div class="detail-info"><div class="detail-label">–ì—Ä–∞—Ñ–∏–∫ —Å–º–µ–Ω</div><div class="detail-value">${v.workSchedule}</div></div></div>`:''}
      <div class="detail-row"><span class="detail-ico">üë•</span><div class="detail-info"><div class="detail-label">–û—Ç–∫–ª–∏–∫–æ–≤</div><div class="detail-value">${rc}</div></div></div>
    </div>
    ${v.desc?`<div class="detail-section"><div class="detail-section-title">–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è</div><p style="font-size:14px;line-height:1.6;color:var(--text2)">${v.desc}</p></div>`:''}
    ${v.housing||v.food||v.clothing||v.transport?`<div class="detail-section"><div class="detail-section-title">–£—Å–ª–æ–≤–∏—è</div>
      ${v.housing?`<div class="detail-row"><span class="detail-ico">üè†</span><div class="detail-info"><div class="detail-label">–ü—Ä–æ–∂–∏–≤–∞–Ω–∏–µ</div><div class="detail-value">${v.housing}</div></div></div>`:''}
      ${v.food?`<div class="detail-row"><span class="detail-ico">üçΩÔ∏è</span><div class="detail-info"><div class="detail-label">–ü–∏—Ç–∞–Ω–∏–µ</div><div class="detail-value">${v.food}</div></div></div>`:''}
      ${v.clothing?`<div class="detail-row"><span class="detail-ico">üëî</span><div class="detail-info"><div class="detail-label">–°–ø–µ—Ü–æ–¥–µ–∂–¥–∞</div><div class="detail-value">${v.clothing}</div></div></div>`:''}
      ${v.transport?`<div class="detail-row"><span class="detail-ico">üöó</span><div class="detail-info"><div class="detail-label">–ü—Ä–æ–µ–∑–¥</div><div class="detail-value">${v.transport}</div></div></div>`:''}
    </div>`:''}
    ${profile?.about?`<div class="detail-section"><div class="detail-section-title">–û –∫–æ–º–ø–∞–Ω–∏–∏</div><p style="font-size:14px;line-height:1.6;color:var(--text2)">${profile.about}</p></div>`:''}
    ${viewAs==='worker'?`<div class="detail-section"><div class="detail-section-title">–û—Ü–µ–Ω–∏—Ç—å —Ä–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª—è</div><div class="stars-row" id="ratingStars">${[1,2,3,4,5].map(i=>`<span class="star" onclick="rateEmployer('${v.eid}',${i})">‚òÜ</span>`).join('')}</div></div>`:''}
    <div style="padding-bottom:8px">${actions}</div>`);
}

// ‚îÄ‚îÄ OPEN CANDIDATE DETAIL ‚îÄ‚îÄ
async function openCandidate(uid) {
  const p = await sbGet('profiles', 'wrk_' + uid); if(!p) return;
  const avatarHtml = p.photo ? `<img src="${p.photo}" style="width:72px;height:72px;border-radius:50%;object-fit:cover;margin:0 auto;display:block;border:3px solid var(--accent)">` : `<div class="avatar-placeholder" style="margin:0 auto">üë∑</div>`;
  const tgLink = p.tg ? `<a href="https://t.me/${p.tg}" class="btn btn-blue" style="text-decoration:none" target="_blank">‚úàÔ∏è Telegram</a>` : '';
  openModal(`
    <div class="modal-handle"></div>
    <div style="text-align:center;margin-bottom:16px">
      ${avatarHtml}
      <div class="modal-title" style="margin-top:10px">${p.name}</div>
      <div style="font-size:13px;color:var(--text2)">${p.specialty}</div>
    </div>
    <div class="detail-section">
      <div class="detail-row"><span class="detail-ico">üìû</span><div class="detail-info"><div class="detail-label">–¢–µ–ª–µ—Ñ–æ–Ω</div><div class="detail-value">${p.phone}</div></div></div>
      <div class="detail-row"><span class="detail-ico">üìä</span><div class="detail-info"><div class="detail-label">–û–ø—ã—Ç —Ä–∞–±–æ—Ç—ã</div><div class="detail-value">${p.experience} ${yrs(p.experience)} (${expRange(p.experience)})</div></div></div>
      <div class="detail-row"><span class="detail-ico">üìç</span><div class="detail-info"><div class="detail-label">–†–µ–≥–∏–æ–Ω</div><div class="detail-value">${p.region||'‚Äî'}</div></div></div>
      ${p.tg?`<div class="detail-row"><span class="detail-ico">‚úàÔ∏è</span><div class="detail-info"><div class="detail-label">Telegram</div><div class="detail-value">@${p.tg}</div></div></div>`:''}
    </div>
    ${p.about?`<div class="detail-section"><div class="detail-section-title">–û —Å–µ–±–µ –∏ –Ω–∞–≤—ã–∫–∏</div><p style="font-size:14px;line-height:1.6;color:var(--text2)">${p.about}</p></div>`:''}
    ${p.docs?`<div class="detail-section"><div class="detail-section-title">–î–æ–∫—É–º–µ–Ω—Ç—ã</div><p style="font-size:14px;line-height:1.6;color:var(--text2)">${p.docs}</p></div>`:''}
    <div class="btn-row">
      <a href="tel:${p.phone}" class="btn btn-green" style="text-decoration:none">üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å</a>
      ${tgLink}
    </div>
    ${ROLE==='employer'?`<button class="btn btn-primary" style="margin-top:10px" onclick="sendOffer('${uid}')">üì© –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ</button>`:''}
    <div style="height:10px"></div>`);
}

// ‚îÄ‚îÄ RESPONSES ‚îÄ‚îÄ
async function sendResponse(vid) {
  const wp = await sbGet('profiles', 'wrk_' + UID);
  if(!wp) { toast('–°–Ω–∞—á–∞–ª–∞ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å!'); closeModal(); wrkTab('profile', null); return; }
  const r = { id: 'resp_' + Date.now(), vid, wid: UID, createdAt: new Date().toISOString() };
  await sbSet('responses', r.id, r);
  const vac = await sbGet('vacancies', vid);
  if(vac) sendBotMsg(vac.eid, `üîî –ù–æ–≤—ã–π –æ—Ç–∫–ª–∏–∫!\n\nüë∑ ${wp.name}\nüîß ${wp.specialty}\nüìç ${wp.region||'‚Äî'}\nüìû ${wp.phone}\n\n–í–∞–∫–∞–Ω—Å–∏—è: ${vac.specialty}`);
  showNotif('–û—Ç–∫–ª–∏–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!', '–†–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∏–ª —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ');
  toast('–û—Ç–∫–ª–∏–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω! ‚úÖ'); closeModal();
}
async function sendOffer(wid) {
  const wp = await sbGet('profiles', 'wrk_' + wid);
  const ep = await sbGet('profiles', 'emp_' + UID);
  if(!wp || !ep) return;
  sendBotMsg(wid, `üíº –í–∞–º –ø–æ—Å—Ç—É–ø–∏–ª–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ!\n\nüè¢ ${ep.companyName}\nüìû ${ep.phone||'‚Äî'}\n\n–û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–µ—Ç–∞–ª–µ–π`);
  toast('–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ! ‚úÖ'); closeModal();
}
async function sendBotMsg(userId, text) {
  try { await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ chat_id: userId, text }) }); } catch(e) {}
}

// ‚îÄ‚îÄ RATING ‚îÄ‚îÄ
async function rateEmployer(eid, score) {
  document.querySelectorAll('#ratingStars .star').forEach((s,i) => { s.textContent = i<score?'‚≠ê':'‚òÜ'; });
  let r = await sbGet('ratings','rating_'+eid) || {avg:0,cnt:0,sum:0};
  r.sum = (r.sum||0) + score; r.cnt++; r.avg = r.sum / r.cnt;
  await sbSet('ratings','rating_'+eid,r);
  toast(`–û—Ü–µ–Ω–∫–∞ ${score}‚≠ê —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!`);
}

// ‚îÄ‚îÄ FAVORITES PAGE ‚îÄ‚îÄ
async function openFavs() {
  let html = '<div class="modal-handle"></div><div class="modal-title">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</div>'; let has = false;
  if(favs.vacancies.length) {
    html += '<div class="detail-section-title" style="margin:16px 0 8px">–í–∞–∫–∞–Ω—Å–∏–∏</div>';
    for(const vid of favs.vacancies) {
      const v = await sbGet('vacancies', vid);
      if(v) { has = true; html += `<div class="vcard" onclick="closeModal();openVacancy('${v.id}','${ROLE}')"><div class="vcard-top"><div class="vcard-title">${v.specialty}</div><div class="vcard-company">${v.companyName}</div><div class="vcard-salary">${salStr(v.salFrom,v.salTo)}</div></div></div>`; }
    }
  }
  if(favs.candidates.length && ROLE==='employer') {
    html += '<div class="detail-section-title" style="margin:16px 0 8px">–ö–∞–Ω–¥–∏–¥–∞—Ç—ã</div>';
    for(const cid of favs.candidates) {
      const c = await sbGet('profiles','wrk_'+cid);
      if(c) { has = true; html += `<div class="vcard" onclick="closeModal();openCandidate('${c.uid}')"><div class="vcard-top"><div class="vcard-title">${c.name}</div><div class="vcard-company">${c.specialty}</div></div></div>`; }
    }
  }
  if(!has) html += `<div class="empty"><div class="empty-ico">‚ù§Ô∏è</div><div class="empty-title">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ –ø—É—Å—Ç–æ</div><div class="empty-text">–ù–∞–∂–∏–º–∞–π—Ç–µ ü§ç –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö</div></div>`;
  html += '<div style="height:20px"></div>';
  openModal(html);
}

// ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ
function openModal(html) {
  let m = document.getElementById('globalModal');
  if(!m) { m = document.createElement('div'); m.id = 'globalModal'; m.className = 'modal'; m.onclick = e => { if(e.target===m) closeModal(); }; document.body.appendChild(m); }
  m.innerHTML = `<div class="modal-box">${html}</div>`;
  m.classList.remove('hidden');
}
function closeModal() { const m = document.getElementById('globalModal'); if(m) m.classList.add('hidden'); }
</script>
</body>
</html>
